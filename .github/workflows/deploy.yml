name: Deploy Production

on:
  push:
    branches: [main]
    tags:
      - 'v*.*.*' # Trigger on version tags like v1.0.0

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Deploy Local
        run: |
          # Navigate to project directory
          cd /home/admin/Desktop/Desktop-NestJS

          # Pull latest code
          git checkout package-lock.json
          git pull origin main

          # Install dependencies
          npm install

          # Build API
          echo "Building API..."
          npm run generate --workspace=packages/database
          # Use db push to sync schema directly because migration history is messy on server
          npx prisma db push --schema=packages/database/prisma/schema.prisma --accept-data-loss
          npm run build:api
          pm2 restart nestjs-api

          # Build Frontend
          echo "Building Frontend..."
          npm install @unovis/ts @unovis/vue --workspace=apps/desktop
          npm run build:web --workspace=apps/desktop

          # Update Static Files
          echo "Updating Static Files..."
          # Note: /var/www/ytrc-app/ is writable by admin group
          rm -rf /var/www/ytrc-app/*
          cp -r apps/desktop/dist/* /var/www/ytrc-app/

          echo "Deployment Complete!"

  build-windows:
    name: Build & Deploy Windows App
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Build Windows App
        run: |
          cd apps/desktop
          npm run build:win

      - name: Deploy to Update Server
        shell: bash
        env:
          SSH_KEY: ${{ secrets.REMOTE_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Add remote host to known_hosts to avoid interaction
          ssh-keyscan -p ${{ secrets.REMOTE_PORT || '22' }} ${{ secrets.REMOTE_HOST }} >> ~/.ssh/known_hosts

          # Use scp to transfer files
          # Note: We use find to get the files and then scp them to preserve directory structure if needed, 
          # but based on the original config, it seems they want to strip 4 components: apps/desktop/release/
          cd apps/desktop/release
          scp -P ${{ secrets.REMOTE_PORT || '22' }} -i ~/.ssh/id_rsa -r **/latest.yml **/*.exe ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }}:/var/www/ytrc-updates/
