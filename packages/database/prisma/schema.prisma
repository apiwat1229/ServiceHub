generator client {
  provider = "prisma-client-js"
  output   = "../../../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Example Models - Customize based on your needs

model User {
  id       String  @id @default(uuid())
  email    String  @unique
  username String? @unique
  password String
  role     String  @default("staff_1")

  // Profile Info
  firstName   String? @map("first_name")
  lastName    String? @map("last_name")
  displayName String? @map("display_name")
  avatar      String?
  permissions Json?   @default("[]") // List of permission strings

  // Work Info
  department String?
  position   String?

  // Security & Status
  status  UserStatus @default(ACTIVE)
  pinCode String?    @map("pin_code")

  // Organization
  employeeId String? @unique @map("employee_id") // YTR-001
  site       String? // 'Head Office', 'Factory A'

  isHod Boolean @default(false) @map("is_hod")

  // Relations
  hodId        String? @map("hod_id")
  hod          User?   @relation("UserHod", fields: [hodId], references: [id])
  subordinates User[]  @relation("UserHod")

  managerId          String? @map("manager_id")
  manager            User?   @relation("UserManager", fields: [managerId], references: [id])
  directSubordinates User[]  @relation("UserManager")

  // Role Management
  roleId     String? @map("role_id")
  roleRecord Role?   @relation(fields: [roleId], references: [id])

  // Notification Groups
  notificationGroups NotificationGroup[] @relation("NotificationGroupMembers")

  // Security
  forceChangePassword Boolean   @default(false) @map("force_change_password")
  failedLoginAttempts Int       @default(0) @map("failed_login_attempts")
  lastLoginAt         DateTime? @map("last_login_at")
  preferences         Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  posts     Post[]

  // Notification System Relations
  notifications    Notification[]
  approvalRequests ApprovalRequest[] @relation("Requester")
  approverRequests ApprovalRequest[] @relation("Approver")

  // App Permissions
  appPermissions UserAppPermission[]

  // Knowledge Center eBooks
  uploadedBooks KnowledgeBook[] @relation("KnowledgeBookUploader")
  bookViews     BookView[]      @relation("BookViewer")

  // IT Help Desk Tickets
  requesterTickets ITTicket[] @relation("TicketRequester")
  assigneeTickets  ITTicket[] @relation("TicketAssignee")

  @@map("users")
}

model UserAppPermission {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  appName   String // "BOOKING", "INVENTORY"
  actions   Json // ["read", "create"]
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, appName])
  @@map("user_app_permissions")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
}

model Post {
  id        String   @id @default(uuid())
  title     String
  content   String?
  published Boolean  @default(false)
  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([authorId])
  @@map("posts")
}

// Master Data: Location
model Province {
  id        Int      @id
  code      String   @unique
  name_th   String
  name_en   String
  createdAt DateTime @default(now()) @map("created_at")

  suppliers Supplier[]
  districts District[]

  @@map("provinces")
}

model District {
  id         Int      @id
  code       String   @unique
  name_th    String
  name_en    String
  provinceId Int      @map("province_id")
  province   Province @relation(fields: [provinceId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  suppliers    Supplier[]
  subdistricts Subdistrict[]

  @@map("districts")
}

model Subdistrict {
  id         Int      @id
  code       String   @unique
  name_th    String
  name_en    String
  zip_code   String?
  createdAt  DateTime @default(now()) @map("created_at")
  districtId Int      @map("district_id")
  district   District @relation(fields: [districtId], references: [id])

  suppliers Supplier[]

  @@map("subdistricts")
}

// Master Data: Rubber Type
model RubberType {
  id          String  @id @default(uuid())
  code        String  @unique
  name        String
  description String?
  category    String?
  is_active   Boolean @default(true) @map("is_active")

  // Soft Delete
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([deletedAt])
  @@map("rubber_types")
}

// Mobile App: Supplier
model Supplier {
  id      String  @id @default(uuid())
  code    String  @unique
  name    String  @map("display_name")
  taxId   String? @map("tax_id")
  address String?
  phone   String?
  email   String?

  provinceId    Int?         @map("province_id")
  province      Province?    @relation(fields: [provinceId], references: [id])
  districtId    Int?         @map("district_id")
  district      District?    @relation(fields: [districtId], references: [id])
  subdistrictId Int?         @map("subdistrict_id")
  subdistrict   Subdistrict? @relation(fields: [subdistrictId], references: [id])

  isActive Boolean @default(true) @map("is_active")
  status   String  @default("ACTIVE") @map("status") // Was is_active boolean, switching to String status for consistency with Users if desired, or keep boolean? 
  // User plan said "status String". I will map `status` to `is_active` logic or just add `status` field. 
  // Existing has `is_active Boolean`. I will replace/update to `status String` to match my plan, or simpler: keep `is_active` and map in DTO. 
  // Let's stick to the plan: `status String`. I'll comment out old `is_active` or remove it.

  notes           String?
  rubberTypeCodes String[] @default([]) @map("rubber_type_codes")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Extra fields from SQL export matching
  firstName     String? @map("first_name")
  lastName      String? @map("last_name")
  title         String?
  avatar        String?
  zipCode       String? @map("zip_code")
  contactPerson String? @map("contact_person")

  // Business Details
  certificateNumber String?   @map("certificate_number")
  certificateExpire DateTime? @map("certificate_expire")
  score             Float?    @default(0)
  eudrQuotaUsed     Float?    @map("eudr_quota_used")
  eudrQuotaCurrent  Float?    @map("eudr_quota_current")

  // Soft Delete
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by")

  @@index([deletedAt])
  @@map("suppliers")
}

// Booking Queue System
model Booking {
  id          String   @id @default(uuid())
  queueNo     Int      @map("queue_no")
  bookingCode String   @unique @map("booking_code")
  date        DateTime
  startTime   String   @map("start_time")
  endTime     String   @map("end_time")
  slot        String?

  // Supplier Information
  supplierId   String @map("supplier_id")
  supplierCode String @map("supplier_code")
  supplierName String @map("supplier_name")

  // Truck Information
  truckType     String? @map("truck_type")
  truckRegister String? @map("truck_register")

  // Rubber Information
  rubberType String @map("rubber_type")
  lotNo      String? @map("lot_no")

  // Lab Results (Main)
  moisture     Float? @map("moisture")
  drcEst       Float? @map("drc_est")
  drcRequested Float? @map("drc_requested")
  drcActual    Float? @map("drc_actual")

  // Metadata
  recorder  String
  note      String?   @map("note")
  status    String    @default("PENDING") @map("status")
  approvedBy String?  @map("approved_by")
  approvedAt DateTime? @map("approved_at")

  checkinAt DateTime? @map("checkin_at")
  checkedInBy String? @map("checked_in_by")

  // Weight Scale Process
  startDrainAt DateTime? @map("start_drain_at")
  startDrainBy String?   @map("start_drain_by")
  
  stopDrainAt  DateTime? @map("stop_drain_at")
  stopDrainBy  String?   @map("stop_drain_by")
  
  drainNote    String?   @map("drain_note")
  
  weightIn     Float?    @map("weight_in")
  weightInBy   String?   @map("weight_in_by")
  
  weightOut    Float?    @map("weight_out")
  weightOutBy  String?   @map("weight_out_by")
  
  rubberSource String?   @map("rubber_source")

  // Trailer Information (For 10-wheel trailer)
  trailerWeightIn     Float?  @map("trailer_weight_in")
  trailerWeightOut    Float?  @map("trailer_weight_out")
  trailerRubberType   String? @map("trailer_rubber_type")
  trailerRubberSource String? @map("trailer_rubber_source")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  labSamples BookingLabSample[]

  // Soft Delete
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by")

  @@index([date, slot])
  @@index([bookingCode])
  @@index([deletedAt])
  @@map("bookings")
}

model BookingLabSample {
  id        String  @id @default(uuid())
  bookingId String  @map("booking_id")
  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  sampleNo Int     @map("sample_no")
  isTrailer Boolean @default(false) @map("is_trailer")

  // Lab Data
  beforePress   Float? @map("before_press")
  basketWeight  Float? @map("basket_weight")
  cuplumpWeight Float? @map("cuplump_weight") // Calculated? Or stored? Storing is safer.
  afterPress    Float? @map("after_press")
  percentCp     Float? @map("percent_cp")

  beforeBaking1 Float? @map("before_baking_1")
  beforeBaking2 Float? @map("before_baking_2")
  beforeBaking3 Float? @map("before_baking_3")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("booking_lab_samples")
}

// ==========================================
// Notification & Approval System
// ==========================================

model Notification {
  id      String             @id @default(uuid())
  title   String
  message String
  type    NotificationType   @default(INFO)
  status  NotificationStatus @default(UNREAD)

  // Recipient
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Metadata
  sourceApp  String // e.g., "BOOKING", "USER_MANAGEMENT"
  actionType String // e.g., "CREATE", "UPDATE", "APPROVAL_REQUEST"
  entityId   String? // ID of the related entity
  actionUrl  String? // Link to relevant page
  metadata   Json? // Extra data

  // Approval Integration
  approvalRequestId String? @map("approval_request_id")
  approvalStatus    String? @map("approval_status") // Snapshot of approval status

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([approvalRequestId])
  @@map("notifications")
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  REQUEST
  APPROVE
}

enum NotificationStatus {
  UNREAD
  READ
  ARCHIVED
}

model NotificationSetting {
  id String @id @default(uuid())

  // Event Definition
  sourceApp  String // e.g., "BOOKING"
  actionType String // e.g., "CREATE", "DELETE", "REQUEST_EDIT"

  // Configuration
  isActive Boolean @default(true)

  // Recipients Configuration
  recipientRoles  Json @default("[]") // Array of Role IDs
  recipientGroups Json @default("[]") // Array of NotificationGroup IDs
  recipientUsers  Json @default("[]") // Array of User IDs (optional overrides)

  channels Json @default("[\"IN_APP\"]") // ["IN_APP", "EMAIL", "LINE"]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([sourceApp, actionType])
  @@map("notification_settings")
}

model ApprovalRequest {
  id String @id @default(uuid())

  // Request Info
  requestType String @map("request_type") // "SUPPLIER_DELETE", "USER_UPDATE", etc.
  entityType  String @map("entity_type") // "Supplier", "User", "Booking"
  entityId    String @map("entity_id") // ID of the entity

  sourceApp  String @map("source_app") // "BOOKING", "USER_MANAGEMENT"
  actionType String @map("action_type") // "CREATE", "UPDATE", "DELETE"

  // Data Snapshots
  currentData  Json? @map("current_data") // Snapshot of current state
  proposedData Json? @map("proposed_data") // Proposed changes

  // Request Details
  reason   String? // Requester's reason
  priority String  @default("NORMAL") // "LOW", "NORMAL", "HIGH", "URGENT"

  // Workflow
  status ApprovalStatus @default(PENDING)

  requesterId String @map("requester_id")
  requester   User   @relation("Requester", fields: [requesterId], references: [id])

  approverId String? @map("approver_id")
  approver   User?   @relation("Approver", fields: [approverId], references: [id])

  // Timestamps
  submittedAt DateTime  @default(now()) @map("submitted_at")
  actedAt     DateTime? @map("acted_at")
  expiresAt   DateTime? @map("expires_at") // Auto-expire if not acted upon

  // Comments & Remarks
  remark String? // Approver's remark (for reject/void/return)

  // Soft Delete
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by")

  // Relations
  logs ApprovalLog[]

  @@index([status])
  @@index([requesterId])
  @@index([approverId])
  @@index([entityType, entityId])
  @@map("approval_requests")
}

model ApprovalLog {
  id String @id @default(uuid())

  // Related Request
  approvalRequestId String          @map("approval_request_id")
  approvalRequest   ApprovalRequest @relation(fields: [approvalRequestId], references: [id], onDelete: Cascade)

  // Action Details
  action   String // "CREATED", "APPROVED", "REJECTED", "RETURNED", "CANCELLED", "VOIDED", "EXPIRED"
  oldValue Json?  @map("old_value") // State before action
  newValue Json?  @map("new_value") // State after action

  // Actor
  actorId   String @map("actor_id")
  actorName String @map("actor_name") // Snapshot of actor name
  actorRole String @map("actor_role") // Snapshot of actor role

  // Metadata
  remark    String? // Reason/comment for the action
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([approvalRequestId])
  @@index([actorId])
  @@map("approval_logs")
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  RETURNED // Sent back for modification
  EXPIRED // Request timed out
  VOID // Approved request invalidated
}

// Role Management System
model Role {
  id          String  @id @default(uuid())
  name        String  @unique
  description String?
  icon        String?
  color       String?
  permissions String[] @default([]) // Array of permission strings
  isActive    Boolean @default(true) @map("is_active")

  // Relations
  users User[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("roles")
}

model NotificationGroup {
  id          String  @id @default(uuid())
  name        String  @unique
  description String?
  icon        String?
  color       String?
  isActive    Boolean @default(true)

  members User[] @relation("NotificationGroupMembers")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================================
// Printer Usage Analytics System
// ==========================================

model PrinterDepartment {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  userMappings PrinterUserMapping[]
  usageRecords PrinterUsageRecord[]

  @@map("printer_departments")
}

model PrinterUserMapping {
  id           String            @id @default(uuid())
  userName     String            @unique @map("user_name")
  departmentId String            @map("department_id")
  department   PrinterDepartment @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  createdAt    DateTime          @default(now()) @map("created_at")
  updatedAt    DateTime          @updatedAt @map("updated_at")

  @@map("printer_user_mappings")
}

model PrinterUsageRecord {
  id           String             @id @default(uuid())
  period       DateTime           // First day of the month for the record
  userName     String             @map("user_name")
  departmentId String?            @map("department_id")
  department   PrinterDepartment? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  
  serialNo     String             @default("unknown") @map("serial_no")
  printBW      Int                @default(0) @map("print_bw")
  printColor   Int                @default(0) @map("print_color")
  copyBW       Int                @default(0) @map("copy_bw")
  copyColor    Int                @default(0) @map("copy_color")
  total        Int                @default(0)

  createdAt    DateTime           @default(now()) @map("created_at")
  updatedAt    DateTime           @updatedAt @map("updated_at")

  @@unique([period, userName, serialNo])
  @@map("printer_usage_records")
}

// ==========================================
// Knowledge Center eBook System
// ==========================================

model KnowledgeBook {
  id            String   @id @default(uuid())
  title         String
  description   String?
  category      String   // 'Getting Started', 'Tutorials', 'Troubleshooting', 'System Guides'
  fileType      String   @map("file_type") // 'pdf'
  filePath      String   @map("file_path") // Storage path
  fileName      String   @map("file_name") // Original filename
  fileSize      Int      @map("file_size") // Size in bytes
  coverImage    String?  @map("cover_image") // Optional cover image path
  author        String?
  uploadedBy    String   @map("uploaded_by")
  uploader      User     @relation("KnowledgeBookUploader", fields: [uploadedBy], references: [id])
  views         Int      @default(0)
  downloads     Int      @default(0)
  tags          String[] @default([]) // Array of tags for search
  isPublished   Boolean  @default(true) @map("is_published")
  trainingDate  DateTime? @map("training_date")
  attendees     Int?      @default(0)
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  viewHistory   BookView[]
  
  @@index([category])
  @@index([uploadedBy])
  @@index([isPublished])
  @@map("knowledge_books")
}

model BookView {
  id        String        @id @default(uuid())
  bookId    String        @map("book_id")
  book      KnowledgeBook @relation(fields: [bookId], references: [id], onDelete: Cascade)
  userId    String        @map("user_id")
  user      User          @relation("BookViewer", fields: [userId], references: [id])
  viewedAt  DateTime      @default(now()) @map("viewed_at")
  
  @@index([bookId])
  @@index([userId])
  @@map("book_views")
}

// ==========================================
// IT Asset Management
// ==========================================

model ITAsset {
  id           String   @id @default(uuid())
  code         String   @unique
  name         String
  category     String // laptop, monitor, peripheral, network, mobile, other
  stock        Int      @default(0)
  minStock     Int      @default(2) @map("min_stock")
  location     String?
  description  String?
  image        String? // Path to image file
  price        Float?   @default(0)
  receivedDate DateTime @default(now()) @map("received_date")
  receiver     String? // Name of receiver
  serialNumber String?  @map("serial_number")
  barcode      String?  // Optional barcode for scanning

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("it_assets")
}

model ITTicket {
  id          String   @id @default(uuid())
  ticketNo    String   @unique @map("ticket_no") // e.g. T-1024
  title       String
  description String?
  category    String // Software, Hardware, Network, etc.
  priority    String   @default("Medium") // Low, Medium, High
  location    String?  // Building, Room, etc.
  status      String   @default("Open") // Open, In Progress, Resolved, Closed

  requesterId String @map("requester_id")
  requester   User   @relation("TicketRequester", fields: [requesterId], references: [id])

  assigneeId String? @map("assignee_id")
  assignee   User?   @relation("TicketAssignee", fields: [assigneeId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([requesterId])
  @@index([assigneeId])
  @@index([status])
  @@map("it_tickets")
}
