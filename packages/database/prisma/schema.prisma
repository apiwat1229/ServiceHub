generator client {
  provider = "prisma-client-js"
  output   = "../../../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Example Models - Customize based on your needs

model User {
  id          String     @id @default(uuid())
  email       String     @unique
  username    String?    @unique
  password    String
  role        String     @default("staff_1")
  
  // Profile Info
  firstName   String?    @map("first_name")
  lastName    String?    @map("last_name")
  displayName String?    @map("display_name")
  avatar      String?
  
  // Work Info
  department  String?
  position    String?
  
  // Security & Status
  status      UserStatus @default(ACTIVE)
  pinCode     String?    @map("pin_code")
  
  // Organization
  hodId       String?    @map("hod_id")
  hod         User?      @relation("UserHod", fields: [hodId], references: [id])
  subordinates User[]    @relation("UserHod")
  
  // Notification Groups
  notificationGroups NotificationGroup[] @relation("NotificationGroupMembers")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  posts     Post[]

  // Notification System Relations
  notifications     Notification[]
  approvalRequests  ApprovalRequest[] @relation("Requester")
  approverRequests  ApprovalRequest[] @relation("Approver")
  
  // App Permissions
  appPermissions    UserAppPermission[]

  @@map("users")
}

model UserAppPermission {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  appName   String   // "BOOKING", "INVENTORY"
  actions   Json     // ["read", "create"]
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, appName])
  @@map("user_app_permissions")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model Post {
  id        String   @id @default(uuid())
  title     String
  content   String?
  published Boolean  @default(false)
  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([authorId])
  @@map("posts")
}



// Master Data: Location
model Province {
  id        Int      @id
  code      String   @unique
  name_th   String
  name_en   String
  createdAt DateTime @default(now()) @map("created_at")
  
  suppliers Supplier[]
  districts District[]

  @@map("provinces")
}

model District {
  id          Int      @id
  code        String   @unique
  name_th     String
  name_en     String
  provinceId  Int      @map("province_id")
  province    Province @relation(fields: [provinceId], references: [id])
  
  createdAt DateTime @default(now()) @map("created_at")

  suppliers    Supplier[]
  subdistricts Subdistrict[]

  @@map("districts")
}



model Subdistrict {
  id         Int      @id
  code       String   @unique
  name_th    String
  name_en    String
  zip_code   String?
  createdAt  DateTime @default(now()) @map("created_at")
  districtId Int      @map("district_id")
  district   District @relation(fields: [districtId], references: [id])
  
  suppliers Supplier[]

  @@map("subdistricts")
}

// Master Data: Rubber Type
model RubberType {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  description String?
  category    String?
  is_active   Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("rubber_types")
}

// Mobile App: Supplier
model Supplier {
  id             String   @id @default(uuid())
  code           String   @unique
  name           String   @map("display_name")
  taxId          String?  @map("tax_id")
  address        String?
  phone          String?
  email          String?

  
  provinceId    Int?         @map("province_id")
  province      Province?    @relation(fields: [provinceId], references: [id])
  districtId    Int?         @map("district_id")
  district      District?    @relation(fields: [districtId], references: [id])
  subdistrictId Int?         @map("subdistrict_id")
  subdistrict   Subdistrict? @relation(fields: [subdistrictId], references: [id])
  
  isActive         Boolean   @default(true) @map("is_active")
  status           String    @default("ACTIVE") @map("status") // Was is_active boolean, switching to String status for consistency with Users if desired, or keep boolean? 
  // User plan said "status String". I will map `status` to `is_active` logic or just add `status` field. 
  // Existing has `is_active Boolean`. I will replace/update to `status String` to match my plan, or simpler: keep `is_active` and map in DTO. 
  // Let's stick to the plan: `status String`. I'll comment out old `is_active` or remove it.
  
  notes            String?
  rubberTypeCodes String[]  @default([]) @map("rubber_type_codes")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Extra fields from SQL export matching
  firstName String? @map("first_name")
  lastName  String? @map("last_name")
  title      String?
  avatar     String?
  zipCode    String?   @map("zip_code")
  contactPerson String? @map("contact_person")
  
  // Business Details
  certificateNumber    String?   @map("certificate_number")
  certificateExpire    DateTime? @map("certificate_expire")
  score               Float?    @default(0)
  eudrQuotaUsed       Float?    @map("eudr_quota_used")
  eudrQuotaCurrent    Float?    @map("eudr_quota_current")

  @@map("suppliers")
}

// Booking Queue System
model Booking {
  id              String    @id @default(uuid())
  queueNo         Int       @map("queue_no")
  bookingCode     String    @unique @map("booking_code")
  date            DateTime
  startTime       String    @map("start_time")
  endTime         String    @map("end_time")
  slot            String?
  
  // Supplier Information
  supplierId      String    @map("supplier_id")
  supplierCode    String    @map("supplier_code")
  supplierName    String    @map("supplier_name")
  
  // Truck Information
  truckType       String?   @map("truck_type")
  truckRegister   String?   @map("truck_register")
  
  // Rubber Information
  rubberType      String    @map("rubber_type")
  
  // Metadata
  recorder        String
  checkinAt       DateTime? @map("checkin_at")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@index([date, slot])
  @@index([bookingCode])
  @@map("bookings")
}

// Role Management
model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  permissions Json?     // Stores permission matrix: { "users": { "orders": ["read", "write"] } }
  color       String?  // UI color class like 'bg-blue-600'
  icon        String?  // Icon name string
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("roles")
}

// ==========================================
// Notification & Approval System
// ==========================================

model Notification {
  id          String   @id @default(uuid())
  title       String
  message     String
  type        NotificationType @default(INFO)
  status      NotificationStatus @default(UNREAD)
  
  // Recipient
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Metadata
  sourceApp   String   // e.g., "BOOKING", "USER_MANAGEMENT"
  actionType  String   // e.g., "CREATE", "UPDATE", "APPROVAL_REQUEST"
  entityId    String?  // ID of the related entity
  actionUrl   String?  // Link to relevant page
  metadata    Json?    // Extra data
  
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@map("notifications")
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

enum NotificationStatus {
  UNREAD
  READ
  ARCHIVED
}

model NotificationSetting {
  id          String   @id @default(uuid())
  
  // Event Definition
  sourceApp   String   // e.g., "BOOKING"
  actionType  String   // e.g., "CREATE", "DELETE", "REQUEST_EDIT"
  
  // Configuration
  isActive    Boolean  @default(true)
  
  // Recipients Configuration
  recipientRoles Json  @default("[]") // Array of Role IDs
  recipientGroups Json @default("[]") // Array of NotificationGroup IDs
  recipientUsers Json  @default("[]") // Array of User IDs (optional overrides)
  
  channels     Json    @default("[\"IN_APP\"]") // ["IN_APP", "EMAIL", "LINE"]

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([sourceApp, actionType])
  @@map("notification_settings")
}

model ApprovalRequest {
  id          String   @id @default(uuid())
  
  // Request Info
  sourceApp   String   // "BOOKING"
  actionType  String   // "UPDATE", "DELETE"
  entityId    String   // ID of the thing changing
  
  // Changes
  reason      String?
  changes     Json?    // { field: "rubberType", old: "A", new: "B" }
  
  // Workflow
  status      ApprovalStatus @default(PENDING)
  
  requesterId String   @map("requester_id")
  requester   User     @relation("Requester", fields: [requesterId], references: [id])
  
  approverId  String?  @map("approver_id")
  approver    User?    @relation("Approver", fields: [approverId], references: [id])
  
  submittedAt DateTime @default(now()) @map("submitted_at")
  actedAt     DateTime? @map("acted_at")
  
  comment     String? // Approver's comment

  @@map("approval_requests")
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}


model NotificationGroup {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  
  members     User[]   @relation("NotificationGroupMembers")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
